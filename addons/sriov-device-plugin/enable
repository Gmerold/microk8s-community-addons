#!/usr/bin/env python3

import argparse
import json
import os
import subprocess
import time
import tempfile

KUBECTL = os.path.expandvars("$SNAP/microk8s-kubectl.wrapper")
SCRIPT_PATH = os.path.abspath(os.path.dirname(__file__))


def main():
    parser = argparse.ArgumentParser()
    parser.add_argument(
        "-r",
        "--resource",
        action="append",
        required=True,
        help="",
    )
    args = parser.parse_args()

    resources = _generate_resources_dict_from_args(args)
    sriovdp_config_manifest = _get_sriovdp_config_manifest(resources)

    print("Enabling SR-IOV Network Device Plugin...")
    _create_sriovdp_config(sriovdp_config_manifest)
    _enable_sriovdp(resources)
    print("SR-IOV Network Device Plugin is now enabled.")


def _generate_resources_dict_from_args(args: argparse.Namespace) -> dict:
    """"""
    resources = {}
    for resource in args.resource:
        resources.update(json.loads(resource))
    return resources


def _get_sriovdp_config_manifest(resources: dict) -> str:
    """"""
    resources_list = {
        "resourceList": [
            {
                "resourceName": resource_name,
                "selectors": {
                    "pciAddresses": pci_addresses
                }
            }
            for resource_name, pci_addresses in resources.items()
        ]
    }

    return f"""apiVersion: v1
kind: ConfigMap
metadata:
  name: sriovdp-config
  namespace: kube-system
data:
  config.json: |
    {json.dumps(resources_list)}
"""


def _create_sriovdp_config(sriovdp_config_manifest: str) -> None:
    with tempfile.NamedTemporaryFile(mode="w+") as sriovdp_config:
        sriovdp_config.write(sriovdp_config_manifest)
        sriovdp_config.flush()

        subprocess.check_call([KUBECTL, "apply", "-f", sriovdp_config.name])


def _enable_sriovdp(resources: dict) -> None:
    subprocess.check_call([KUBECTL, "apply", "-f", os.path.join(SCRIPT_PATH, "sriovdp.yaml")])

    now = time.time()
    timeout = 300
    while time.time() - now <= timeout:
        node_details = subprocess.check_output(
            [KUBECTL, "get", "node", "-o", "json"]
        ).decode("utf-8")
        allocatable_resources = json.loads(node_details).get("items")[0].get("status").get(
            "allocatable"
        )
        if not all(
            allocatable_resources[f"intel.com/{resource}"] and
            allocatable_resources[f"intel.com/{resource}"] == str(len(pci_addresses))
            for resource, pci_addresses in resources.items()
        ):
            print("Waiting for SR-IOV Network Device Plugin to be ready...")
            time.sleep(5)
        else:
            return

    raise TimeoutError("Unable to start SR-IOV Network Device Plugin. Operation timed out!")


if __name__ == "__main__":
    main()
